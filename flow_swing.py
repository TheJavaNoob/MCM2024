import pandas as pd
import time
import math
import matplotlib.pyplot as plt
import numpy as np
import sys

df = pd.read_csv("data2.csv").iloc[:,:]

t = 0
match_num = 0
set_num = 0
game_num = 0
point_num = 1
match_num_max = 0
set_num_max = 0
game_num_max = 0
point_num_max = 1
for t in range(1,df.shape[0]):
    if df.iloc[t, 5] != df.iloc[t - 1, 5]:
        point_num = 0
        game_num += 1
        game_num_max = game_num_max if game_num_max > game_num else game_num
    if df.iloc[t, 4] != df.iloc[t - 1, 4]:
        game_num = 0
        set_num += 1
        set_num_max = set_num_max if set_num_max > set_num else set_num
    if df.iloc[t, 0] != df.iloc[t - 1, 0]:
        set_num = 0
        match_num += 1
        match_num_max = match_num_max if match_num_max > match_num else match_num
    point_num += 1
    point_num_max = point_num_max if point_num_max > point_num else point_num

match_num = 0
set_num = 0
game_num = 0
point_num = 1
indices = np.zeros((match_num_max + 1, set_num_max + 1, game_num_max + 1, point_num_max + 1)).astype(int)
for t in range(1, df.shape[0]):#df.shape[0])
    if df.iloc[t, 5] != df.iloc[t - 1, 5]:
        point_num = 0
        game_num += 1
    if df.iloc[t, 4] != df.iloc[t - 1, 4]:
        game_num = 0
        set_num += 1
    if df.iloc[t, 0] != df.iloc[t - 1, 0]:
        set_num = 0
        match_num += 1
    indices[match_num, set_num, game_num, point_num] = t
    point_num += 1 
    
w = [1, 3.6840315, 13.57208808]
#w = [1, 10, 100]
"""
Dij = w[0] * df.loc[:,["p1_points_won"]].values + w[1] * df.loc[:,["p1_games"]].values + w[2] * df.loc[:,["p1_sets"]].values
Dji = w[0] * df.loc[:,["p2_points_won"]].values + w[1] * df.loc[:,["p2_games"]].values + w[2] * df.loc[:,["p2_sets"]].values
flow = Dij - Dji
"""
Origin=[-4.6840315, 0.0, 4.6840315, 0.0, -4.6840315000000015, 0.0, -4.684031499999998, 0.0, -4.684031500000003, -9.368063000000003, -4.6840315, 0.0, 4.6840315, 9.368062999999996, 4.684031499999996, 9.368063, 4.684031500000003, 0.0, -4.684031500000003, 0.0, 4.684031499999996, 0.0, 4.684031500000003, 9.368063, 4.684031499999996, 0.0, 4.684031500000003, 0.0, -4.684031499999989, 0.0, -4.684031500000003, 0.0, 4.684031500000003, 9.368063000000006, 4.684031500000003, 0.0, -4.684031500000003, -9.368063000000006, -14.052094499999995, -9.368062999999992, -14.052094499999995, -18.736126, -23.420157500000002, -18.736126, -23.420157500000002, -18.736126000000013, -23.420157500000002, -28.104189000000005, -32.78822050000001, -28.104189000000005, -23.420157500000002, -18.736126, -14.052094499999995, -18.736126, -23.420157499999974, -18.736125999999985, -23.420157499999988, -28.10418899999999, -23.420157499999988, -18.736125999999985, -14.052094499999981, -9.368063000000006, -14.05209450000001, -18.736126000000013, -23.420157500000016, -28.10418900000002, -23.420157500000016, -18.736126000000013, -14.05209450000001, -9.368063000000006, -4.684031500000003, -9.368063000000006, -14.05209450000001, -18.736126000000013, -23.420157500000016, -18.736126000000013, -14.05209450000001, -9.368063000000006, -4.684031500000003, -9.368063000000006, -4.684031500000003, -9.368062999999978, -14.052094499999981, -9.368062999999978, -14.052094499999981, -9.368063000000006, -14.05209450000001, -9.368063000000006, -14.05209450000001, -9.368063000000006, -4.684031500000003, -9.368063000000006, -14.05209450000001, -9.368063000000006, -14.05209450000001, -18.736126000000013, -14.05209450000001, -9.368063000000006, -4.684031500000003, 0.0, -4.684031499999975, 0.0, -4.684031500000003, -9.368063000000006, -14.05209450000001, -9.368063000000006, -14.05209450000001, -18.736126000000013, -23.420157500000016, -18.736126000000013, -23.420157500000016, -28.10418900000002, -23.420157500000016, -18.736126000000013, -23.42015749999996, -28.10418900000002, -32.788220499999966, -37.472252000000026, -42.15628349999997, -37.47225199999997, -32.788220499999966, -37.472252000000026, -42.15628349999997, -37.47225199999997, -32.788220499999966, -28.10418900000002, -23.42015749999996, -18.736126000000013, -14.052094499999953, -18.736126000000013, -23.42015749999996, -28.104188999999963, -32.788220499999966, -28.10418900000002, -32.78822050000002, -28.104188999999963, -23.420157500000016, -18.736125999999956, -23.42015749999996, -28.104188999999963, -23.420157500000016, -28.10418900000002, -32.78822050000002, -28.10418900000002, -23.420157500000016, -18.736126000000013, -14.05209450000001, -9.368063000000006, -14.05209450000001, -18.736126000000013, -23.420157500000016, -18.736126000000013, -14.05209450000001, -18.736126000000013, -23.420157500000016, -28.10418900000002, -32.78822050000002, -37.47225199999997, -32.788220499999966, -28.104188999999963, -23.42015749999996, -28.104188999999963, -23.42015749999996, -18.736125999999956, -14.052094499999953, -9.36806299999995, -14.052094499999953, -18.736125999999956, -23.42015749999996, -18.736126000000013, -14.05209450000001, -18.736126000000013, -23.420157500000016, -18.736126000000013, -14.05209450000001, -9.368063000000006, -4.684031500000003, -9.368063000000006, -14.05209450000001, -9.368063000000006, -14.05209450000001, -18.736126000000013, -14.05209450000001, -9.368063000000006, -14.05209450000001, -9.368063000000006, -4.684031500000003, 0.0, -4.684031500000003, -9.368063000000006, -4.684031500000003, -9.368063000000006, -4.684031500000003, -9.368063000000006, -14.05209450000001, -18.736126000000013, -14.05209450000001, -9.368063000000006, -14.052094499999953, -9.36806299999995, -14.052094499999953, -18.736125999999956, -23.42015749999996, -28.104188999999963, -23.42015749999996, -18.736126000000013, -14.05209450000001, -9.368063000000006, -14.05209450000001, -18.736126000000013, -14.05209450000001, -9.368063000000006, -14.05209450000001, -9.368063000000006, -14.05209450000001, -18.736126000000013, -14.05209450000001, -9.368063000000006, -4.684031500000003, -9.36806299999995, -4.684031499999946, -9.368063000000006, -14.052094500000067, -18.736126000000013, -23.42015749999996, -28.10418900000002, -23.420157500000073, -28.104189000000133, -32.78822050000008, -28.10418900000002, -23.42015749999996, -18.736126000000013, -23.42015749999996, -18.736126000000013, -23.42015749999996, -28.10418900000002, -32.78822050000008, -28.10418900000002, -32.788220499999966, -37.47225199999991, -42.15628349999997, -46.84031500000003]
Predict=[-4.6840315, -4.440892098500626e-16, 4.6840315, -8.881784197001252e-16, -4.6840315000000015, 0.0, -4.6840315, -1.7763568394002505e-15, -4.684031500000003, -9.368063000000003, -4.6840315, 0.0, 4.6840315, 9.368062999999996, 4.684031499999996, 9.368063, 4.6840315, 0.0, -4.684031500000003, 0.0, 4.684031499999996, 0.0, 4.684031500000003, 9.368063, 4.684031499999996, 0.0, 4.684031500000003, 0.0, -4.684031499999996, -7.105427357601002e-15, -4.68403150000001, -7.105427357601002e-15, 4.684031499999996, 9.368063, 4.684031499999996, 0.0, -4.684031500000003, -9.368063000000006, -14.052094499999995, -9.368062999999992, -14.052094499999995, -18.736126, -23.420157500000002, -18.736126, -23.420157500000002, -18.736126000000013, -23.420157500000002, -28.104189000000005, -32.78822050000001, -28.104189000000005, -23.420157500000002, -18.736126, -14.052094499999995, -18.736126, -23.420157499999988, -18.736126, -23.420157500000002, -28.104189000000005, -23.420157500000002, -18.736126, -14.052094499999995, -9.36806300000002, -14.052094500000024, -18.736126000000027, -23.420157500000016, -28.10418900000002, -23.420157500000016, -18.736126000000013, -14.05209450000001, -9.368063000000006, -4.684031500000003, -9.368063000000006, -14.05209450000001, -18.736126000000013, -23.420157500000016, -18.736126000000013, -14.05209450000001, -9.368063000000006, -4.684031500000003, -9.368063000000006, -4.684031500000003, -9.368062999999978, -14.052094499999981, -9.368062999999978, -14.052094499999981, -9.368063000000006, -14.05209450000001, -9.368063000000006, -14.05209450000001, -9.368063000000006, -4.684031500000003, -9.368063000000006, -14.05209450000001, -9.368063000000006, -14.05209450000001, -18.736126000000013, -14.05209450000001, -9.368063000000006, -4.684031500000003, 0.0, -4.684031499999975, 0.0, -4.684031500000003, -9.368063000000006, -14.05209450000001, -9.368063000000006, -14.05209450000001, -18.736126000000013, -23.420157500000016, -18.736126000000013, -23.420157500000016, -28.10418900000002, -23.420157500000016, -18.736126000000013, -23.420157499999988, -28.10418899999999, -32.788220499999994, -37.472252, -42.1562835, -37.472252, -32.788220499999994, -37.472252, -42.1562835, -37.472252, -32.788220499999994, -28.104189000000048, -23.420157499999988, -18.73612600000004, -14.052094499999981, -18.736125999999985, -23.420157499999988, -28.104188999999963, -32.788220499999966, -28.10418900000002, -32.78822050000002, -28.104188999999963, -23.420157500000016, -18.736125999999956, -23.42015749999996, -28.104188999999963, -23.420157500000016, -28.10418900000002, -32.78822050000002, -28.10418900000002, -23.420157500000016, -18.736126000000013, -14.05209450000001, -9.368063000000006, -14.05209450000001, -18.736126000000013, -23.420157500000016, -18.736126000000013, -14.05209450000001, -18.736126000000013, -23.420157500000016, -28.10418900000002, -32.78822050000002, -37.47225199999997, -32.788220499999966, -28.104188999999963, -23.42015749999996, -28.104188999999963, -23.42015749999996, -18.736125999999956, -14.052094499999953, -9.36806299999995, -14.052094499999953, -18.736125999999956, -23.42015749999996, -18.736126000000013, -14.05209450000001, -18.736126000000013, -23.420157500000016, -18.736126000000013, -14.05209450000001, -9.368063000000006, -4.684031500000003, -9.368063000000006, -14.05209450000001, -9.368063000000006, -14.05209450000001, -18.736126000000013, -14.05209450000001, -9.368063000000006, -14.05209450000001, -9.368063000000006, -4.684031500000003, 0.0, -4.684031500000003, -9.368063000000006, -4.684031500000003, -9.368063000000006, -4.684031500000003, -9.368063000000006, -14.05209450000001, -18.736126000000013, -14.05209450000001, -9.368063000000006, -14.052094499999953, -18.736125999999956, -14.052094499999953, -9.36806299999995, -14.052094499999953, -18.736125999999956, -14.05209450000001, -9.368063000000006, -4.684031500000003, 0.0, -4.684031500000003, -9.368063000000006, -14.05209450000001, -9.368063000000006, -14.05209450000001, -18.736126000000013, -23.420157500000016, -28.10418900000002, -23.420157500000016, -18.736126000000013, -14.05209450000001, -9.368063000000006, -4.684031500000003, -9.368063000000006, -14.05209450000001, -18.736126000000013, -23.420157500000016, -18.73612600000007, -23.420157500000073, -18.736126000000013, -14.052094499999953, -9.368063000000006, -4.68403150000006, 0.0, -4.684031500000003, 5.684341886080802e-14, -4.684031499999946, -9.368062999999893, -14.052094499999896, -9.36806299999995, -14.052094499999953, -18.736125999999956, -23.42015749999996, -28.104188999999963]
Pr=[-4.6840315, -4.440892098500626e-16, 4.6840315, -8.881784197001252e-16, -4.6840315000000015, 0.0, -4.6840315, -1.7763568394002505e-15, -4.684031500000003, -9.368063000000003, -4.6840315, 0.0, 4.6840315, 9.368062999999996, 4.684031499999996, 9.368063, 4.6840315, 0.0, -4.684031500000003, 0.0, 4.684031499999996, 0.0, 4.684031500000003, 9.368063, 4.684031499999996, 0.0, 4.684031500000003, 0.0, -4.684031499999996, -7.105427357601002e-15, -4.68403150000001, -7.105427357601002e-15, 4.684031499999996, 9.368063, 4.684031499999996, 0.0, -4.684031500000003, -9.368063000000006, -14.052094499999995, -9.368062999999992, -14.052094499999995, -18.736126, -23.420157500000002, -18.736126, -23.420157500000002, -18.736126000000013, -23.420157500000002, -28.104189000000005, -32.78822050000001, -28.104189000000005, -23.420157500000002, -18.736126, -14.052094499999995, -18.736126, -23.420157499999988, -18.736126, -23.420157500000002, -28.104189000000005, -23.420157500000002, -18.736126, -14.052094499999995, -9.36806300000002, -14.052094500000024, -18.736126000000027, -23.420157500000016, -28.10418900000002, -23.420157500000016, -18.736126000000013, -14.05209450000001, -9.368063000000006, -4.684031500000003, -9.368063000000006, -14.05209450000001, -18.736126000000013, -23.420157500000016, -18.736126000000013, -14.05209450000001, -9.368063000000006, -4.684031500000003, -9.368063000000006, -4.684031500000003, -9.368062999999978, -14.052094499999981, -9.368062999999978, -14.052094499999981, -9.368063000000006, -14.05209450000001, -9.368063000000006, -14.05209450000001, -9.368063000000006, -4.684031500000003, -9.368063000000006, -14.05209450000001, -9.368063000000006, -14.05209450000001, -18.736126000000013, -14.05209450000001, -9.368063000000006, -4.684031500000003, 0.0, -4.684031499999975, -9.368062999999978, -14.052094499999981, -18.736125999999985, -23.420157499999988, -18.736126000000013, -23.420157500000016, -28.10418900000002, -23.420157500000016, -18.736126000000013, -23.420157500000016, -28.10418900000002, -23.420157500000016, -18.736126000000013, -23.420157499999988, -28.10418899999999, -32.788220499999994, -37.472252, -42.1562835, -46.840315000000004, -42.1562835, -46.840315000000004, -42.1562835, -46.840315000000004, -42.1562835, -37.472252, -32.78822050000005, -37.472252000000054, -32.788220499999994, -37.47225199999997, -42.15628349999997, -46.840314999999975, -51.52434649999998, -46.84031500000003, -42.15628349999997, -37.472252000000026, -32.788220499999966, -28.10418900000002, -32.78822050000002, -37.472252000000026, -42.15628350000003, -37.47225199999997, -42.15628349999997, -37.472252000000026, -32.78822050000002, -28.10418900000002, -23.420157500000016, -28.10418900000002, -32.78822050000002, -37.472252000000026, -42.15628350000003, -46.84031500000003, -42.15628350000003, -46.84031500000003, -51.52434649999998, -46.840314999999975, -51.52434649999998, -46.840314999999975, -42.15628349999997, -37.47225199999997, -32.788220499999966, -28.104188999999963, -23.42015749999996, -18.736125999999956, -14.052094499999953, -18.736125999999956, -14.052094499999953, -18.736125999999956, -23.42015749999996, -28.104188999999963, -23.420157500000016, -28.10418900000002, -32.78822050000002, -28.10418900000002, -23.420157500000016, -18.736126000000013, -14.05209450000001, -18.736126000000013, -23.420157500000016, -28.10418900000002, -23.420157500000016, -28.10418900000002, -23.420157500000016, -18.736126000000013, -14.05209450000001, -9.368063000000006, -4.684031500000003, -9.368063000000006, -14.05209450000001, -9.368063000000006, -14.05209450000001, -18.736126000000013, -14.05209450000001, -9.368063000000006, -14.05209450000001, -18.736126000000013, -14.05209450000001, -9.368063000000006, -14.052094499999953, -9.36806299999995, -14.052094499999953, -18.736125999999956, -23.42015749999996, -28.104188999999963, -23.42015749999996, -18.736126000000013, -14.05209450000001, -9.368063000000006, -14.05209450000001, -18.736126000000013, -14.05209450000001, -9.368063000000006, -14.05209450000001, -9.368063000000006, -14.05209450000001, -18.736126000000013, -14.05209450000001, -9.368063000000006, -4.684031500000003, -9.368063000000006, -4.684031500000003, -9.368063000000006, -14.05209450000001, -18.736126000000013, -23.420157500000016, -28.10418900000002, -23.420157500000073, -28.104189000000076, -32.78822050000008, -28.10418900000002, -23.42015749999996, -18.736126000000013, -23.42015749999996, -18.736126000000013, -23.420157500000016, -28.10418900000002, -32.78822050000002, -28.104188999999963, -32.788220499999966, -37.47225199999997, -42.15628349999997, -46.840314999999975]
m = 0
Predict[100:150] = Pr
flow = np.pad(Predict,(0,df.shape[0]))
Origin = np.pad(Origin,(0,df.shape[0]))
game_st = []
game_avgs = []
game_swings = []
set_st = []
set_avgs = []
set_swings = []
for i in range(np.count_nonzero(indices[m,:,0,0]) + (indices[m,0,0,0] == 0)): #set
    next_id = indices[m,i + 1,0,0] if i < (np.count_nonzero(indices[m,:,0,0]) + (indices[m,0,0,0] == 0) - 1) else indices[m + 1,0,0,0]
    set_avg = np.average(flow[indices[m,i,0,0]:next_id - 1])
    set_st.append(next_id)
    set_avgs.append(set_avg)
    for j in range(np.count_nonzero(indices[m,i,:,0]) + (indices[m,i,0,0] == 0)): #game
        if j < (np.count_nonzero(indices[m,i,:,0]) + (indices[m,i,0,0] == 0) - 1):
            next_id = indices[m,i,j + 1,0]
        else:
            if i < (np.count_nonzero(indices[m,:,0,0]) + (indices[m,0,0,0] == 0) - 1):
                next_id = indices[m,i + 1,0,0]
            else:
                next_id = indices[m + 1,0,0,0]
        game_avg = np.average(flow[indices[m,i,j,0]:next_id - 1])
        game_st.append(next_id)
        game_avgs.append(game_avg)
        for k in range(np.count_nonzero(indices[m,i,j,:]) + (indices[m,i,j,0] == 0)): #point
            if (flow[indices[m,i,j,k]] < game_avg) ^ (flow[indices[m,i,j,k] + 1] < game_avg):
                game_swings.append(indices[m,i,j,k])
            if i > 0 and (flow[indices[m,i,j,k]] < set_avg) ^ (flow[indices[m,i,j,k] + 1] < set_avg):
                set_swings.append(indices[m,i,j,k])
                
                
default_blue = plt.rcParams['axes.prop_cycle'].by_key()['color'][0]

                
game_st.insert(0,0)
game_avgs.insert(0,game_avgs[0])
set_st.insert(0,0)
set_avgs.insert(0,set_avgs[0])

plt.plot(range(0,150), flow[0:150],color='r',label="predicted")
plt.plot(range(0,242), Origin[0:242],color=default_blue,label="original")
plt.scatter(game_swings, flow[np.array(game_swings)],s=10,color='c',label='game_swing')
#plt.scatter(set_swings, flow[np.array(set_swings)],s=20,color='b',label='set_swing')
#plt.xlim([50,100])

game_st_st = game_st.copy()
game_st_st.insert(0, 0)
game_st_st.pop()
plt.hlines(game_avgs,game_st_st,game_st, color='y',label="game_avg")
"""
set_st_st = set_st.copy()
set_st_st.insert(0, 0)
set_st_st.pop()
plt.hlines(set_avgs,set_st_st,set_st, color='g',label="set_average")
"""

plt.legend()
plt.xlabel("points")
plt.ylabel("flow")
plt.xlim([0,242])
